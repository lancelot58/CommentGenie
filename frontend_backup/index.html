<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿè¯„è¯­ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container main-container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <div>
                <h1 style="margin-bottom: 5px;">å­¦ç”Ÿè¯„è¯­ç”Ÿæˆå™¨</h1>
                <div class="user-info">
                    æ¬¢è¿ï¼Œ<span id="username"></span>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>

        <!-- æ¶ˆæ¯æç¤ºåŒºåŸŸ -->
        <div id="message"></div>

        <!-- è¯„è¯­ç”Ÿæˆè¡¨å• -->
        <div class="card">
            <h2>ç”Ÿæˆå­¦ç”Ÿè¯„è¯­</h2>

            <form id="generateForm">
                <div class="form-group">
                    <label for="studentName">å­¦ç”Ÿå§“å *</label>
                    <input
                        type="text"
                        id="studentName"
                        placeholder="è¯·è¾“å…¥å­¦ç”Ÿå§“å"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="studentInfo">å­¦ç”Ÿæƒ…å†µ *</label>
                    <textarea
                        id="studentInfo"
                        placeholder="è¯·æè¿°å­¦ç”Ÿçš„æ€§æ ¼ã€æˆç»©ã€è¡¨ç°ç­‰ä¿¡æ¯ï¼Œè¶Šè¯¦ç»†è¶Šå¥½&#10;ä¾‹å¦‚ï¼šæ€§æ ¼å¼€æœ—æ´»æ³¼ï¼Œå­¦ä¹ æˆç»©ä¼˜ç§€ï¼Œç§¯æå‚åŠ ç­çº§æ´»åŠ¨ï¼Œä¹äºåŠ©äºº"
                        required
                        rows="4"
                    ></textarea>
                    <small style="color: #999; font-size: 12px;">
                        æç¤ºï¼šä¿¡æ¯è¶Šè¯¦ç»†ï¼Œç”Ÿæˆçš„è¯„è¯­è¶Šä¸ªæ€§åŒ–
                    </small>
                </div>

                <div class="form-group">
                    <label for="aiModel">AI æ¨¡å‹</label>
                    <select id="aiModel">
                        <!-- å°†é€šè¿‡ JavaScript åŠ¨æ€å¡«å…… -->
                    </select>
                </div>

                <button type="submit" class="btn" id="generateBtn">
                    ç”Ÿæˆè¯„è¯­
                </button>
            </form>
        </div>

        <!-- ç”Ÿæˆç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
        <div id="resultCard" class="card hidden">
            <h2>ç”Ÿæˆçš„è¯„è¯­</h2>
            <div class="card-content" id="generatedComment" style="white-space: pre-wrap;"></div>
            <div class="card-footer">
                <span class="badge" id="usedModel"></span>
                <button class="btn-secondary" style="padding: 8px 15px; width: auto;" onclick="copyComment()">
                    å¤åˆ¶è¯„è¯­
                </button>
            </div>
        </div>

        <!-- è¯„è¯­å†å² -->
        <div class="mt-20">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">å†å²è®°å½•</h2>
                <button class="btn-secondary" style="padding: 8px 15px; width: auto;" onclick="loadHistory()">
                    åˆ·æ–°
                </button>
            </div>

            <div id="historyList">
                <!-- å°†é€šè¿‡ JavaScript åŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.addEventListener('load', () => {
            requireAuth();

            // æ˜¾ç¤ºç”¨æˆ·å
            const user = getCurrentUser();
            document.getElementById('username').textContent = user.username;

            // å¡«å…… AI æ¨¡å‹é€‰é¡¹
            const aiModelSelect = document.getElementById('aiModel');
            AI_MODELS.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.label;
                aiModelSelect.appendChild(option);
            });

            // åŠ è½½å†å²è®°å½•
            loadHistory();
        });

        // ç”Ÿæˆè¯„è¯­è¡¨å•æäº¤
        document.getElementById('generateForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const studentName = document.getElementById('studentName').value.trim();
            const studentInfo = document.getElementById('studentInfo').value.trim();
            const aiModel = document.getElementById('aiModel').value;
            const generateBtn = document.getElementById('generateBtn');

            if (!studentName || !studentInfo) {
                showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }

            // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            generateBtn.disabled = true;
            generateBtn.innerHTML = 'ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™<span class="loading"></span>';

            // éšè—ä¹‹å‰çš„ç»“æœ
            document.getElementById('resultCard').classList.add('hidden');

            try {
                const response = await fetch(API_ENDPOINTS.generateComment, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        student_name: studentName,
                        student_info: studentInfo,
                        ai_model: aiModel,
                    }),
                });

                const data = await response.json();

                if (data.success) {
                    // æ˜¾ç¤ºç”Ÿæˆçš„è¯„è¯­
                    document.getElementById('generatedComment').textContent = data.comment;
                    document.getElementById('usedModel').textContent = aiModel.toUpperCase();
                    document.getElementById('resultCard').classList.remove('hidden');

                    showMessage('è¯„è¯­ç”ŸæˆæˆåŠŸï¼', 'success');

                    // åˆ·æ–°å†å²è®°å½•
                    loadHistory();

                    // æ¸…ç©ºè¡¨å•ï¼ˆå¯é€‰ï¼‰
                    // document.getElementById('generateForm').reset();
                } else {
                    showMessage(data.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                console.error('ç”Ÿæˆé”™è¯¯:', error);
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨', 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'ç”Ÿæˆè¯„è¯­';
            }
        });

        // åŠ è½½å†å²è®°å½•
        async function loadHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<div class="text-center" style="padding: 20px; color: #999;">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_ENDPOINTS.commentHistory}?limit=10`, {
                    headers: getAuthHeaders(),
                });

                const data = await response.json();

                if (data.success && data.comments.length > 0) {
                    historyList.innerHTML = '';
                    data.comments.forEach(comment => {
                        const card = createHistoryCard(comment);
                        historyList.appendChild(card);
                    });
                } else {
                    historyList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <div>è¿˜æ²¡æœ‰ç”Ÿæˆè¿‡è¯„è¯­</div>
                            <div style="font-size: 12px; margin-top: 5px;">å¿«å»ç”Ÿæˆç¬¬ä¸€æ¡è¯„è¯­å§ï¼</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½å†å²é”™è¯¯:', error);
                historyList.innerHTML = `
                    <div class="empty-state">
                        <div>åŠ è½½å¤±è´¥</div>
                        <button class="btn-secondary" style="margin-top: 10px; width: auto; padding: 8px 15px;" onclick="loadHistory()">
                            é‡è¯•
                        </button>
                    </div>
                `;
            }
        }

        // åˆ›å»ºå†å²è®°å½•å¡ç‰‡
        function createHistoryCard(comment) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title">${escapeHtml(comment.student_name)}</div>
                    <div class="card-meta">${formatDate(comment.created_at)}</div>
                </div>
                <div class="card-content" style="white-space: pre-wrap;">${escapeHtml(comment.generated_comment)}</div>
                <div class="card-footer">
                    <span class="badge">${comment.ai_model.toUpperCase()}</span>
                    <div>
                        <button class="btn-secondary" style="padding: 6px 12px; width: auto; font-size: 12px; margin-right: 5px;" onclick="copyText('${escapeHtml(comment.generated_comment).replace(/'/g, "\\'")}')">
                            å¤åˆ¶
                        </button>
                        <button class="btn-danger" style="padding: 6px 12px; width: auto; font-size: 12px;" onclick="deleteComment(${comment.id})">
                            åˆ é™¤
                        </button>
                    </div>
                </div>
            `;
            return card;
        }

        // å¤åˆ¶å½“å‰ç”Ÿæˆçš„è¯„è¯­
        function copyComment() {
            const comment = document.getElementById('generatedComment').textContent;
            copyText(comment);
        }

        // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // åˆ é™¤è¯„è¯­
        async function deleteComment(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è¯­å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(API_ENDPOINTS.deleteComment(id), {
                    method: 'DELETE',
                    headers: getAuthHeaders(),
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('åˆ é™¤æˆåŠŸ', 'success');
                    loadHistory();
                } else {
                    showMessage(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤é”™è¯¯:', error);
                showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(text, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';

            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;

            // å°äº1åˆ†é’Ÿ
            if (diff < 60000) {
                return 'åˆšåˆš';
            }
            // å°äº1å°æ—¶
            if (diff < 3600000) {
                return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`;
            }
            // å°äº1å¤©
            if (diff < 86400000) {
                return `${Math.floor(diff / 3600000)}å°æ—¶å‰`;
            }
            // å…¶ä»–æƒ…å†µæ˜¾ç¤ºå®Œæ•´æ—¥æœŸ
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // HTML è½¬ä¹‰ï¼ˆé˜²æ­¢ XSSï¼‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
